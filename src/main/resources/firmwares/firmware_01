
/*
Arduino com shield ethernet com chipset wiznet
Autor Emerson Andrade


Versão: 1.0.4

Codigos das operações:
01 - ligaDesligaPorta
02 - ligarPorta
03 - desligaPorta
99 - Status dos arduino 


*/

#include <SPI.h>
#include <Ethernet.h>
#include <stdio.h>
#include <stdlib.h>



byte mac[] = { 0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED };

IPAddress ip(192,168,1, 177);

EthernetServer server(80);


static String keyArduino = "xxxxxxxxx"; // <-- colocar uma chave com 32 caracteres



void setup()
{
  Ethernet.begin(mac, ip);
  server.begin();
  Serial.begin(9600);
  
  pinMode(6, OUTPUT); 
  pinMode(7, OUTPUT); 
 
  
  digitalWrite(6, HIGH);
  digitalWrite(7, HIGH);
  
}

boolean chaveValida(String httpReq){
  int indexKey = httpReq.indexOf("key=");
  String  keyParam = httpReq.substring(indexKey + 4, indexKey + 36);  
 
  Serial.println(keyParam);
  
  if( keyArduino.equals(keyParam) ){
    return true;
  }else {
    return false;
  }  
}

int converteInt(String n){
   if(n.equals("06")){
      return 6;
   } else if( n.equals("07") ){
      return 7; 
   } else {
      return 0; 
   }
}  

void ligaDesligaPorta(int port, String httpReq){
 
   int indexOp  = httpReq.indexOf("delay=");
   String opParam = httpReq.substring( indexOp + 6, indexOp + 8);
    
  digitalWrite(port, LOW);
  delay( );// implemetar conversao do opParam para int em millisegundos
  digitalWrite(port, HIGH);  
}

void ligaPorta(int port){
  digitalWrite(port, LOW);
} 

void desligaPorta(int port){
  digitalWrite(port, HIGH);
} 


void loop()
{
  // listen for incoming clients
  EthernetClient client = server.available();
  if (client) {
    
    boolean currentLineIsBlank = true;
    String httpReq = ""; 
   
    while (client.connected()) {
      if (client.available()) {
        char c = client.read();
        httpReq += c ;
        
        if (c == '\n' && currentLineIsBlank) {
          client.println("HTTP/1.1 200 OK");
          client.println("Content-Type: text/html");
          client.println();
          
          if(chaveValida(httpReq)){
            
             // Carregando parametros
             int indexPorta  = httpReq.indexOf("port=");
             String portaParam = httpReq.substring(indexPorta  + 5, indexPorta  + 7);
    
             int indexOp  = httpReq.indexOf("op=");
             String opParam = httpReq.substring( indexOp + 3, indexOp + 5);
                                 
             
             if(opParam.equals("01")){
                ligaDesligaPorta( converteInt(portaParam), httpReq ); 
                client.println("<result>OK</result>"); 
             } else if( opParam.equals("02") ){
               	ligaPorta(  converteInt(portaParam) );
                client.println("<result>OK</result>"); 
             } else if( opParam.equals("03") ){
               	desligaPorta( converteInt(portaParam) );
                client.println("<result>OK</result>");    
              } else if( opParam.equals("99") ){
                client.println("<result>OK</result>"); 
             } 
                
                    
          } else {  
             client.println("<error>ERROR:Chave invalida</error>"); 
          } 
            
             
          break;
        }
           
        if (c == '\n') {
            currentLineIsBlank = true;
        } else if (c != '\r') {
            currentLineIsBlank = false;
        }
      }
    }
   
    
    delay(1);
    client.stop();
  }
}